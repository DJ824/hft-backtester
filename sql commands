SELECT * FROM orders


WITH latest_snapshot AS (
    SELECT * FROM limit_orderbook
    WHERE timestamp = (SELECT MAX(timestamp) FROM limit_orderbook)
),
ranked_asks AS (
    SELECT
        price,
        volume,
        ROW_NUMBER() OVER (ORDER BY price ASC) as row_num
    FROM latest_snapshot
    WHERE side = false
),
ranked_bids AS (
    SELECT
        price,
        volume,
        ROW_NUMBER() OVER (ORDER BY price DESC) as row_num
    FROM latest_snapshot
    WHERE side = true
),
top_asks AS (
    SELECT price, volume
    FROM ranked_asks
    WHERE row_num <= 10
),
top_bids AS (
    SELECT price, volume
    FROM ranked_bids
    WHERE row_num <= 10
)
SELECT 'Ask' AS order_type, price, volume
FROM top_asks
UNION ALL
SELECT 'Bid' AS order_type, price, volume
FROM top_bids
ORDER BY
    CASE
        WHEN order_type = 'Ask' THEN 1
        ELSE 2
    END,
    CASE
        WHEN order_type = 'Ask' THEN -price
        ELSE -price
    END;

